name: Data Mining
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Game Version(x.xx)"
        required: true
        default: "7.00"

env:
  tag: patch-${{ github.event.inputs.version }}
  library_repo: harukaxxxx/ffxiv-datamining-tw
  teamcraft_repo: ffxiv-teamcraft/ffxiv-teamcraft
  teamcraft_fork: harukaxxxx/ffxiv-teamcraft

jobs:
  server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Cache Node Dependencies üé∂
        id: cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{runner.OS}}-npm-caches-${{ hashFiles('yarn.lock') }}

      - name: Fetch library
        run: git clone --branch $tag --depth 1 https://github.com/${library_repo}.git library

      - name: Check node version
        run: node -v

      - name: Install dependency
        run: yarn

      - name: Run script
        run: node server.js

      - name: Deploy to Github Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@4.1.0
        with:
          branch: gh-pages
          folder: dist
          clean: true

  teamcraft:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch library
        run: git clone --branch $tag --depth 1 https://github.com/${library_repo}.git library

      - name: Clone teamcraft
        run: git clone --branch staging --depth 1 https://github.com/${teamcraft_repo}.git teamcraft

      - name: Check node version
        run: node -v

      - name: Replace source directory
        run: |
          sed -i "s/\/library\/[0-9.]\+\//\/library\//" teamcraft/data-extraction/data-exporter/config/tw.js
          sed -i "s/file: 'cht'/file: ''/" teamcraft/data-extraction/data-exporter/config/tw.js

      - name: Run data generator
        run: node --max-old-space-size=4096 teamcraft/data-extraction/data-exporter/index-tw.js

      - name: Setting origin
        run: |
          cd teamcraft
          git remote set-url origin https://github.com/${teamcraft_repo}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.WORKER_ACCESS_KEY }}
          path: teamcraft
          commit-message: "feat(data): update for tw ${{ env.tag }}"
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          push-to-fork: ${{ env.teamcraft_fork }}
          branch: ci/tw/datamining-${{ env.tag }}
          base: staging
          title: "feat(data): update for tw ${{ env.tag }}"
          body: |
            This PR is automatically generated by [ffxiv-datamining-worker](https://github.com/zhyupe/ffxiv-datamining-worker)
